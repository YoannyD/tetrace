<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record model="ir.actions.act_window" id="action_version_view">
        <field name="name">Versiones</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">tetrace.sale_order_version</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('sale_order_id','=',active_id)]</field>
    </record>
    
    <act_window id="action_tetrace_prevision_facturacion"
                name="Gestion facturación"
                view_mode="tree,form"
                res_model="tetrace.prevision_facturacion"/>

    <menuitem action="action_tetrace_prevision_facturacion"
              id="menu_tetrace_prevision_facturacion"
              name="Gestion facturación"
              parent="sale.sale_menu_root"
              sequence="3"/>
    
    <record model="ir.ui.view" id="view_order_form">
        <field name="name">sale.order.form.tetrace</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="model">sale.order</field>
        <field name="arch" type="xml">
            <xpath expr="//header[1]" position="inside">
                <field name="visible_btn_generar_proyecto" invisible="1"/>
                <button name="action_generar_proyecto"
                        type="object"
                        class="oe_highlight"
                        attrs="{'invisible': ['|', '|', ('state', '!=', 'draft'), ('visible_btn_generar_proyecto', '=', False)]}"
                        string="Generar Proyecto"/>
                
                <button name="action_crear_version"
                        type="object"
                        string="Generar Version"/>
                
                <button name="action_importar_productos"
                        type="object"
                        string="Importar productos"/>
            </xpath>

            <xpath expr="//div[@name='button_box']" position="inside">
                <field name="version_ids" invisible="1"/>
                <button name="%(action_version_view)d"
                        type="action"
                        class="oe_stat_button"
                        icon="fa-tasks">
                    <field name="version_count" widget="statinfo" string="Versiones"/>
                </button>
            </xpath>

            <xpath expr="//div[hasclass('oe_title')]" position="replace">
                <div class="oe_title">
                    <div class="row">
                        <div class="col-6">
                            <h1>
                                <field name="name" invisible="1"/>
                                <field name="rfq"/>
                            </h1>
                        </div>
                        <div class="col-6">
                            <h1 class="d-flex flex-row">
                                <div>
                                    P
                                </div>
                                <div>
                                    <field name="ejercicio_proyecto"/>
                                </div>
                                <div>
                                    <field name="tipo_proyecto_id" context="{'mostrar_tipo_nombre' : 1}"/>
                                </div>
                                <div>
                                    .
                                </div>
                                <div>
                                    <field name="num_proyecto"/>
                                </div>
                            </h1>
                        </div>
                    </div>
                </div>
            </xpath>

             <xpath expr="//field[@name='partner_id']" position="attributes">
                <attribute name="domain">[('is_company', '=', True)]</attribute>
                <attribute name="context">{'res_partner_search_mode': 'customer', 'solo_company': 1, 'show_address': 1, 'show_vat': True}</attribute>
            </xpath>

            <xpath expr="//group[1]/group[2]" position="inside">
                <field name="ref_proyecto" invisible="1"/>
                <label for="nombre_proyecto"/>
                <div class="d-flex flex-row">
                    <div style="padding-right:8px;">
                        <field name="partner_siglas"/>
                    </div>
                    <div style="padding-right:8px;">
                        <field name="tipo_servicio_id"/>
                    </div>
                    <div style="padding-right:8px;">
                        <field name="proyecto_country_id"/>
                    </div>
                    <div>
                        <field name="detalle_proyecto"/>
                    </div>
                </div>
                <field name="nombre_proyecto" invisible="1"/>
                <field name="referencia_proyecto_antigua"/>
                <field name="coordinador_proyecto_id"/>
                <field name="seguidor_proyecto_ids" widget="many2many_tags"/>
            </xpath>

            <xpath expr="//field[@name='order_line']//tree[1]/field[@name='name']" position="after">
                <field name="job_id" optional="hide"/>
                <field name="individual" optional="hide"/>
                <field name="product_entregado" invisible="1"/>
            </xpath>
            
<!--             <xpath expr="//field[@name='order_line']//tree[1]/field[@name='qty_delivered']" position="attributes">
                <attribute name="attrs">{'column_invisible': [('parent.state', 'not in', ['sale', 'done'])],'readonly': ['|', ('product_entregado', '=', True), ('qty_delivered_method', '!=', 'manual')]}</attribute>
            </xpath> -->
            
            <xpath expr="//field[@name='order_line'][1]/tree[1]/field[@name='price_unit']" position="attributes">
                <attribute name="attrs">{}</attribute>
            </xpath>
            
            <xpath expr="//field[@name='order_line'][1]/tree[1]/field[@name='price_subtotal']" position="after">
                <field name="no_imprimir" optional="hide"/>
            </xpath>
            
            <xpath expr="//notebook[1]" position="inside">
                <page string="Datos proyecto" attrs="{'invisible': [('project_ids', '=', [])]}">
                    <group>
                        <field name="descripcion_proyecto"/>
                        <field name="cabecera_proyecto"/>
                    </group>
                </page>
            </xpath>
            
            <xpath expr="//notebook[1]" position="inside">
                <page string="Gestion facturación">
                    <button name="action_generar_prevision_facturacion" 
                           type="object"
                           string="Generar previsión"
                           class="btn-primary"/>
                    
                    <field name="prevision_facturacion_ids" nolabel="1">
                        <tree editable="bottom">
                            <field name="fecha"/>
                            <field name="feedbak"/>
                            <field name="observaciones"/>
                            <field name="importe_factura"/>
                            <field name="importe"/>
                            <field name="currency_id" invisible="1"/>
                            <field name="facturado"/>
                        </tree>
                    </field>
                    
                    <group name="note_group" col="6">
                        <group class="oe_subtotal_footer oe_right" colspan="2" name="prevision_total">
                            <field name="total_previsto" 
                                   widget="monetary" 
                                   options="{'currency_field': 'currency_id'}"/>
                        </group>
                        <div class="oe_clear"/>
                    </group>
                </page>
                
                <page name="ref_fuera_catalogo" string="Fuera de catálogo" attrs="{'invisible': [('ref_producto_ids', '=', False)]}">
                    <field name="ref_producto_ids" nolabel="1">
                        <tree editable="bottom">
                            <field name="name"/>
                            <field name="cantidad"/>
                        </tree>
                    </field>
                </page>
                
                <page name="imputaciones_variables" string="Imputaciones variables">
                    <button name="action_imputar_variables"
                            type="object"
                            class="oe_highlight"
                            string="Imputar"/>
                    
                    <field name="imputacion_variable_ids" nolabel="1">
                        <tree editable="bottom">
                            <field name="product_id"/>
                            <field name="name"/>
                            <field name="coste"/>
                            <field name="currency_id" invisible="1"/>
                        </tree>
                        
                        <form>
                            <group>
                                <field name="product_id"/>
                                <field name="name"/>
                                <field name="coste"/>
                                <field name="currency_id" invisible="1"/>
                            </group>
                            <group string="Repartición en las líneas del pedido">
                                <field name="line_ids" readonly="1" nolabel="1">
                                    <tree>
                                        <field name="order_line_id"/>
                                        <field name="order_line_product_id"/>
                                        <field name="incremento"/>
                                        <field name="currency_id" invisible="1"/>
                                    </tree>
                                </field>
                            </group>
                        </form>
                    </field>
                    <group class="oe_subtotal_footer oe_right" colspan="2" name="imputacion_total">
                        <field name="total_imputacion_variable" string="Total"/>
                    </group>
                    <div class="oe_clear"/>
                </page>
            </xpath>
        </field>
    </record>

    <record model="ir.ui.view" id="view_quotation_tree">
        <field name="name">sale.order.tree.tetrace</field>
        <field name="inherit_id" ref="sale.view_quotation_tree"/>
        <field name="model">sale.order</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='name']" position="after">
                <field name="rfq"/>
                <field name="ref_proyecto"/>
                <field name="nombre_proyecto"/>
                <field name="referencia_proyecto_antigua"/>
                <field name="coordinador_proyecto_id"/>
            </xpath>
        </field>
    </record>

    <record model="ir.ui.view" id="view_sales_order_filter">
        <field name="name">sale.order.list.select.tetrace</field>
        <field name="inherit_id" ref="sale.view_sales_order_filter"/>
        <field name="model">sale.order</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='name']" position="after">
                <field name="rfq"/>
                <field name="ref_proyecto"/>
                <field name="nombre_proyecto"/>
                <field name="referencia_proyecto_antigua"/>
            </xpath>
            
            <xpath expr="//group[1]" position="inside">
                <filter string="Coordinadores proyecto" 
                        name="group_coordinador_proyecto_id" 
                        domain="[]" 
                        context="{'group_by': 'coordinador_proyecto_id'}"/>
            </xpath>
        </field>
    </record>
    
    <record model="ir.ui.view" id="tetrace_prevision_facturacion_form">
        <field name="name">tetrace.prevision_facturacion.form</field>
        <field name="model">tetrace.prevision_facturacion</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <group>
                        <group>
                            <field name="order_id" invisible="1" readonly="1"/>
                            <field name="order_partner_id" readonly="1"/>
                            <field name="order_nombre_proyecto" readonly="1"/>
                            <field name="order_project_estado_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="fecha" readonly="1"/>
                            <field name="feedbak" readonly="1"/>
                            <field name="observaciones" readonly="1"/>
                            <field name="importe_factura" readonly="1"/>
                            <field name="importe" readonly="1"/>
                            <field name="facturado" readonly="1"/>
                            <field name="currency_id" invisible="1"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>
    
    <record model="ir.ui.view" id="tetrace_prevision_facturacion_tree">
        <field name="name">tetrace.prevision_facturacion.tree</field>
        <field name="model">tetrace.prevision_facturacion</field>
        <field name="arch" type="xml">
            <tree>
                <field name="order_id" invisible="1"/>
                <field name="order_partner_id"/>
                <field name="order_nombre_proyecto"/>
                <field name="order_project_estado_id"/>
                <field name="fecha"/>
                <field name="feedbak"/>
                <field name="importe_factura"/>
                <field name="importe"/>
                <field name="facturado"/>
                <field name="currency_id" invisible="1"/>
            </tree>
        </field>
    </record>
    
    <record model="ir.ui.view" id="tetrace_prevision_facturacion_search">
        <field name="name">tetrace.prevision_facturacion.search</field>
        <field name="model">tetrace.prevision_facturacion</field>
        <field name="arch" type="xml">
            <search>
                <filter string="Facturado" name="filter_facturado" domain="[('facturado', '=', True)]"/>
                <filter string="No Facturado" name="filter_no_facturado" domain="[('facturado', '=', False)]"/>
                <group expand="0" name="group_by" string="Group By">
                    <filter name="group_order_nombre_proyecto" string="Nombre proyecto" context="{'group_by': 'order_nombre_proyecto'}"/>
                    <filter name="group_order_project_estado_id" string="Estado proyecto" context="{'group_by': 'order_project_estado_id'}"/>
                    <filter name="group_partner_id" string="Clientes" context="{'group_by': 'order_partner_id'}"/>
                    <filter name="group_fecha" string="Fecha prevista" context="{'group_by': 'fecha'}"/>
                </group>
            </search>
        </field>
    </record>
</odoo>
