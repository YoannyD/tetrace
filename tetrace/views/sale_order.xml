<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record model="ir.actions.act_window" id="action_version_view">
        <field name="name">Versiones</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">tetrace.sale_order_version</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('sale_order_id','=',active_id)]</field>
    </record>
    
    <record model="ir.ui.view" id="view_order_form">
        <field name="name">sale.order.form.tetrace</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="model">sale.order</field>
        <field name="arch" type="xml">
            <xpath expr="//header[1]" position="inside">
                <field name="visible_btn_generar_proyecto" invisible="1"/>
                <button name="action_generar_proyecto"
                        type="object"
                        class="oe_highlight"
                        attrs="{'invisible': ['|', '|', ('state', '!=', 'draft'), ('visible_btn_generar_proyecto', '=', False)]}"
                        string="Generar Proyecto"/>
                
                <button name="action_crear_version"
                        type="object"
                        string="Generar Version"/>
            </xpath>

            <xpath expr="//div[@name='button_box']" position="inside">
                <field name="version_ids" invisible="1"/>
                <button name="%(action_version_view)d"
                        type="action"
                        class="oe_stat_button"
                        icon="fa-tasks">
                    <field name="version_count" widget="statinfo" string="Versiones"/>
                </button>
            </xpath>

            <xpath expr="//div[hasclass('oe_title')]" position="replace">
                <div class="oe_title">
                    <div class="row">
                        <div class="col-6">
                            <h1>
                                <field name="name"/>
                            </h1>
                        </div>
                        <div class="col-6">
                            <h1 class="d-flex flex-row">
                                <div>
                                    P
                                </div>
                                <div>
                                    <field name="ejercicio_proyecto"/>
                                </div>
                                <div>
                                    <field name="tipo_proyecto_id" context="{'mostrar_tipo_nombre' : 1}"/>
                                </div>
                                <div>
                                    .
                                </div>
                                <div>
                                    <field name="num_proyecto"/>
                                </div>
                            </h1>
                        </div>
                    </div>
                </div>
            </xpath>

             <xpath expr="//field[@name='partner_id']" position="attributes">
                <attribute name="domain">[('is_company', '=', True)]</attribute>
                <attribute name="context">{'res_partner_search_mode': 'customer', 'solo_company': 1, 'show_address': 1, 'show_vat': True}</attribute>
            </xpath>

            <xpath expr="//group[1]/group[2]" position="inside">
                <field name="ref_proyecto" invisible="1"/>
                <label for="nombre_proyecto"/>
                <div class="d-flex flex-row">
                    <div style="padding-right:8px;">
                        <field name="partner_siglas"/>
                    </div>
                    <div style="padding-right:8px;">
                        <field name="tipo_servicio_id"/>
                    </div>
                    <div style="padding-right:8px;">
                        <field name="proyecto_country_id"/>
                    </div>
                    <div>
                        <field name="detalle_proyecto"/>
                    </div>
                </div>
                <field name="nombre_proyecto" invisible="1"/>
                <field name="referencia_proyecto_antigua"/>
                <field name="coordinador_proyecto_id"/>
                <field name="seguidor_proyecto_ids" widget="many2many_tags"/>
            </xpath>

            <xpath expr="//field[@name='order_line']//tree[1]/field[@name='name']" position="after">
                <field name="job_id" optional="hide"/>
            </xpath>
            
            <xpath expr="//field[@name='order_line'][1]/tree[1]/field[@name='price_unit']" position="attributes">
                <attribute name="attrs">{}</attribute>
            </xpath>
            
            <xpath expr="//field[@name='order_line'][1]/tree[1]/field[@name='price_subtotal']" position="after">
                <field name="no_imprimir" optional="hide"/>
            </xpath>
            
            <xpath expr="//notebook[1]" position="inside">
                <page string="Datos proyecto" attrs="{'invisible': [('project_ids', '=', [])]}">
                    <group>
                        <field name="descripcion_proyecto"/>
                        <field name="cabecera_proyecto"/>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <record model="ir.ui.view" id="view_quotation_tree">
        <field name="name">sale.order.tree.tetrace</field>
        <field name="inherit_id" ref="sale.view_quotation_tree"/>
        <field name="model">sale.order</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='name']" position="after">
                <field name="ref_proyecto"/>
                <field name="nombre_proyecto"/>
                <field name="referencia_proyecto_antigua"/>
                <field name="coordinador_proyecto_id"/>
            </xpath>
        </field>
    </record>

    <record model="ir.ui.view" id="view_sales_order_filter">
        <field name="name">sale.order.list.select.tetrace</field>
        <field name="inherit_id" ref="sale.view_sales_order_filter"/>
        <field name="model">sale.order</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='name']" position="after">
                <field name="ref_proyecto"/>
                <field name="nombre_proyecto"/>
                <field name="referencia_proyecto_antigua"/>
            </xpath>
            
            <xpath expr="//group[1]" position="inside">
                <filter string="Coordinadores proyecto" 
                        name="group_coordinador_proyecto_id" 
                        domain="[]" 
                        context="{'group_by': 'coordinador_proyecto_id'}"/>
            </xpath>
        </field>
    </record>
</odoo>
