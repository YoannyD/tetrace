<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <report id="action_report_proyecto"
            string="Proyectos"
            model="sale.order"
            report_type="qweb-pdf"
            file="tetrace.report_saleorder_proyecto"
            name="tetrace.report_saleorder_proyecto"
            print_report_name="(object.state in ('draft', 'sent') and 'Quotation - %s' % (object.name)) or 'Order - %s' % (object.name)"
    />

    <template id="report_saleorder_proyecto_document">
        <t t-set="doc" t-value="doc.with_context(lang=doc.partner_id.lang)"/>
        <div class="page">
            <div class="row" style="margin:32px auto 0 auto;max-width:90%;">
                <div class="col-12">
                    <strong t-esc="doc.descripcion_proyecto"/>
                </div>

                <div class="col-12" style="margin-top:32px;">
                    <strong><span t-field="doc.partner_id"/></strong> <br/>
                    <t t-if="doc.partner_id.street">
                        <span t-field="doc.partner_id.street"/> <br/>
                    </t>
                    <t t-if="doc.partner_id.street2">
                        <span t-field="doc.partner_id.street"/> <br/>
                    </t>

                    <t t-if="doc.partner_id.zip or doc.partner_id.city or doc.partner_id.state_id or doc.partner_id.country_id">
                        <span t-field="doc.partner_id.zip"/>
                        <span t-field="doc.partner_id.city"/>

                        <t t-if="doc.partner_id.state_id">
                            , <span t-field="doc.partner_id.state_id"/>
                        </t>

                        <t t-if="doc.partner_id.country_id">
                            (<span t-field="doc.partner_id.country_id"/>)
                        </t>
                        <br/>
                    </t>

                    <t t-if="doc.partner_id.vat">
                        <span t-field="doc.partner_id.vat"/>
                    </t>
                </div>

                <div class="col-12" style="margin-top:32px;">
                    <div style="text-align:right;">
                        <t t-if="doc.company_id.city">
                            En <span t-field="doc.company_id.city"/>, a
                        </t>
                        <span t-field="doc.date_order" t-options='{"format": "d MMMM y"}'/>.
                    </div>
                </div>

                <div class="col-12" style="margin-top:32px;">
                    <span t-field="doc.cabecera_proyecto"/>
                </div>
            </div>

            <div class="row" style="margin:32px auto 0 auto;max-width:90%;">
                <div class="col-12">
                    <t t-set="num_linea" t-value="1"/>
                    <t t-foreach="doc.order_line" t-as="line">


                        <t t-if="line.display_type == 'line_section'">
                            <div style="color:#872292;text-decoration: underline; font-weight:bold;margin-top:26px;">
                                <span t-field="line.name"/>
                            </div>
                        </t>

                        <t t-if="line.display_type == 'line_note'">
                            <div style="padding-left:25px;margin-top:8px;">
                                <span t-field="line.name"/>
                            </div>
                        </t>

                        <t t-if="line.display_type not in ['line_section', 'line_note']">
                            <div style="font-weight:bold;white-space: nowrap; text-overflow: ellipsis;margin-top:8px">
                                <t t-esc="'%s.' % num_linea"/>
                                <span t-field="line.name"/>

                                <t t-if="line.price_subtotal == 0">
                                    INCLUIDO
                                </t>

                                <t t-if="line.price_subtotal > 0">
                                    <div style="display:inline-block;float:right">
                                        <span t-field="line.price_subtotal"/> / <span t-field="line.product_uom"/>
                                    </div>
                                </t>

                            </div>
                            <t t-set="num_linea" t-value="num_linea + line_index"/>
                        </t>
                    </t>
                </div>
            </div>

            <div class="row" style="margin:32px auto 0 auto;max-width:90%;">
                <div class="col-12">
                    <span t-field="doc.note"/>
                </div>
            </div>

            <div class="row" style="margin:48px auto 0 auto;max-width:90%;min-height:120px;">
                <div class="col-12">
                    <div style="width:50%;float:left;text-align:center">
                        <strong>Firma / Sello</strong>
                        <img t-if="doc.signature" t-att-src="image_data_uri(doc.signature)" style="max-height: 4cm; max-width: 8cm;"/>
                        <span t-field="doc.signed_by"/>
                    </div>
                    <div style="width:50%;float:left;text-align:center">
                        <strong>Firma / Sello</strong>

                        <span t-field="doc.signed_by"/>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="html_report_proyecto">
        <html t-att-lang="lang and lang.replace('_', '-')"
              t-att-data-report-margin-top="data_report_margin_top"
              t-att-data-report-header-spacing="data_report_header_spacing"
              t-att-data-report-dpi="data_report_dpi"
              t-att-data-report-landscape="data_report_landscape"
              t-att-web-base-url="web_base_url">
            <head>
                <meta charset="utf-8"/>
                <meta name="viewport" content="initial-scale=1"/>
                <title><t t-esc="title or 'Odoo Report'"/></title>
                <t t-call-assets="web.report_assets_common" t-js="false"/>
                <t t-call-assets="web.assets_common" t-css="false"/>
                <t t-call-assets="web.report_assets_common" t-css="false"/>
            </head>
            <body>
                <div style="width:100%;height:100vh;background-color:#872292;padding:0;">
                    <div style="width:98%;height:100%;background-color:white;">
                        <header class="row">
                            <div class="col-md-12">
                                <div class="cab_proyecto">
                                    <t t-set="base_url" t-value="request.env['ir.config_parameter'].get_param('web.base.url')"/>
                                    <img t-att-src="'%s/tetrace/static/src/img/cab_report_proyecto.jpg' % base_url" width="100%"/>
                                </div>
                            </div>
                        </header>

                        <main style="padding:0;margin:0;">
                            <t t-raw="0"/>
                        </main>

                        <t t-if="not o" t-set="o" t-value="doc"/>

                        <t t-if="not company">
                            <!-- Multicompany -->
                            <t t-if="company_id">
                                <t t-set="company" t-value="company_id"/>
                            </t>
                            <t t-elif="o and 'company_id' in o">
                                <t t-set="company" t-value="o.company_id.sudo()"/>
                            </t>
                            <t t-else="else">
                                <t t-set="company" t-value="res_company"/>
                            </t>
                        </t>

                        <footer t-attf-class="footer o_standard_footer">
                            <div class="text-center" style="border-top: 1px solid #872292;">
                                <div class="row" style="margin:20px auto;max-width:90%;">
                                    <div class="col-12">
                                        <div style="float:left">
                                            <img t-att-src="'%s/tetrace/static/src/img/logo_report_footer.png' % base_url" width="240px;"/>
                                        </div>

                                        <div style="float:right">
                                            <span t-field="company.name"/>
                                            <t t-if="company.vat">
                                                | CIF: <span t-field="company.vat"/>
                                            </t>
                                        </div>

                                        <div t-if="report_type == 'pdf'" class="text-muted">
                                            Page: <span class="page"/> / <span class="topage"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </footer>
                    </div>
                </div>
            </body>
        </html>
    </template>

    <template id="report_saleorder_proyecto">
        <t t-call="tetrace.html_report_proyecto">
            <t t-foreach="docs" t-as="doc">
                <t t-call="tetrace.report_saleorder_proyecto_document" t-lang="doc.partner_id.lang"/>
            </t>
        </t>
    </template>

    <template id="report_saleorder_document" inherit_id="sale.report_saleorder_document">
        <xpath expr="//th[@name='th_taxes']" position="attributes">
            <attribute name="style">display:none</attribute>
        </xpath>

        <xpath expr="//td[@name='td_taxes']" position="attributes">
            <attribute name="style">display:none</attribute>
        </xpath>

        <xpath expr="//div[@name='so_total_summary']" position="attributes">
            <attribute name="t-if">not proyecto</attribute>
        </xpath>
    </template>

    <template id="report_invoice_document_inherit_sale" inherit_id="sale.report_invoice_document_inherit_sale">
        <xpath expr="//div[@groups='sale.group_delivery_invoice_address']" position="attributes">
            <attribute name="style">padding-top:15px;padding-bottom:15px;</attribute>
        </xpath>

        <xpath expr="//div[@t-field='o.partner_id']" position="attributes">
            <attribute name="style">display:none</attribute>
        </xpath>
    </template>
</odoo>
